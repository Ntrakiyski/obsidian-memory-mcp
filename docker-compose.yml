version: '3.8'

services:
  obsidian-memory-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obsidian-memory-mcp
    
    # Mount a volume for persistent storage of Markdown files
    # This allows other services to access the knowledge graph data
    volumes:
      # Use named volume for better persistence and multi-service access
      - obsidian-data:/app/data:rw
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=6666
      - MEMORY_DIR=/app/data/root_vault
      # Sync configuration
      - ENABLE_SYNC=true
      - SYNC_INTERVAL_MINUTES=5
      - NEO4J_MCP_URL=https://0brainos-mcp.trakiyski.work/mcp
    
    # Restart policy - keep the server running
    restart: unless-stopped
    
    # Working directory
    working_dir: /app
    
    # Health check to verify service is running
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6666/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Traefik routing labels for Coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp.rule=PathPrefix(`/mcp`)"
      - "traefik.http.services.mcp.loadbalancer.server.port=6666"

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: obsidian-dashboard

    # Restart policy - keep the service running
    restart: unless-stopped

    # Environment variables
    environment:
      # Use public URL for Coolify deployment (Traefik routing)
      - MCP_URL=https://obsidian-mcp.trakiyski.work/mcp
      - ENABLE_SYNC=true
      - SYNC_INTERVAL_MINUTES=5

    # Traefik routing labels for Coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3000"

# Named volume for better management and multi-service access
volumes:
  obsidian-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
