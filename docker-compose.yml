version: '3.8'

services:
  obsidian-memory-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: obsidian-memory-mcp
    
    # Mount a volume for persistent storage of Markdown files
    # This allows other services to access the knowledge graph data
    volumes:
      # Use named volume for better persistence and multi-service access
      - obsidian-data:/app/data:rw
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=6666
      - MEMORY_DIR=/app/data/root_vault
    
    # Restart policy - keep the server running
    restart: unless-stopped
    
    # Working directory
    working_dir: /app
    
    # Health check to verify service is running
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:6666/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Traefik routing labels for Coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp.rule=PathPrefix(`/mcp`)"
      - "traefik.http.middlewares.mcp-stripprefix.stripprefix.prefixes=/mcp"
      - "traefik.http.routers.mcp.middlewares=mcp-stripprefix"
      - "traefik.http.services.mcp.loadbalancer.server.port=6666"

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: obsidian-dashboard

    # Restart policy - keep the service running
    restart: unless-stopped

    # Environment variables
    environment:
      # Server-side: API route uses this to connect to MCP server
      - MCP_URL=http://obsidian-memory-mcp:6666/mcp
      # Client-side: Not currently used, but kept for reference
      - NEXT_PUBLIC_MCP_URL=http://obsidian-memory-mcp:6666

    # Traefik routing labels for Coolify
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3000"

# Named volume for better management and multi-service access
volumes:
  obsidian-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data
